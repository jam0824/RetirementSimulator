<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è€å¾Œè³‡é‡‘ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    label { display: block; margin: 6px 0; }
    input[type="number"] { width: 120px; margin-left: 8px; }
    button { margin-top: 12px; padding: 8px 16px; }
    #output { margin-top: 20px; white-space: pre-wrap; background: #f9f9f9;
              padding: 10px; border: 1px solid #ddd; max-height: 400px;
              overflow-y: auto; font-family: monospace; }
  </style>
</head>
<body>
  <h1>è€å¾Œè³‡é‡‘ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
  <p style="color: #666; margin-bottom: 20px; padding: 10px; background-color: #f0f8ff; border-left: 4px solid #007acc; border-radius: 4px;">
    ğŸ”’ <strong>ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼é‡è¦–:</strong> ã“ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é€šä¿¡ã‚’ã›ãšãƒ­ãƒ¼ã‚«ãƒ«ã§å‹•ãã®ã§å®‰å¿ƒã—ã¦ãã ã•ã„ã€‚ã‚ãªãŸã®è²¡å‹™æƒ…å ±ãŒå¤–éƒ¨ã«é€ä¿¡ã•ã‚Œã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
  </p>
  <div id="controls">
    <label>ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹å¹´é½¢: <input id="startAge" type="number" value="30" min="0"></label>
    <label>é€€è·å¹´é½¢: <input id="retirementAge" type="number" value="65" min="0"></label>
    <label>å¹´é‡‘é–‹å§‹å¹´é½¢: <input id="pensionStartAge" type="number" value="65" min="0"></label>
    <label>é€€è·å¾Œåå…¥(æœˆé¡): <input id="gapIncome" type="number" value="0" min="0"></label>
    <label>çµ¦ä¸(å¹´å): <input id="salary" type="number" value="3000000" min="0"></label>
    <label>å¹´é‡‘æœˆé¡: <input id="monthlyPension" type="number" value="145000" min="0"></label>
    <label>é–‹å§‹æ™‚è²¯é‡‘: <input id="initialCash" type="number" value="1000000" min="0"></label>
    <label>é–‹å§‹æ™‚æŠ•è³‡æ®‹é«˜: <input id="initialInv" type="number" value="0" min="0"></label>
    <label>ç¾å½¹æ™‚ç”Ÿæ´»è²»(æœˆé¡): <input id="expenseCurrent" type="number" value="155600" min="0"></label>
    <label>é€€è·ï½å¹´é‡‘é–‹å§‹æœŸé–“ã®ç”Ÿæ´»è²»(æœˆé¡): <input id="expenseGap" type="number" value="228000" min="0"></label>
    <label>è€å¾Œç”Ÿæ´»è²»(æœˆé¡): <input id="expenseRetired" type="number" value="228000" min="0"></label>
    <label>æŠ•è³‡ç‡(%): <input id="investRate" type="number" value="20" min="0" max="100"></label>
    <label>åˆ©å›ã‚Š(å¹´%): <input id="interest" type="number" value="4" min="0" step="0.1"></label>
    <label>ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿç‡(æœˆ%): <input id="eventProb" type="number" value="1" min="0" step="0.1"></label>
    <button id="runBtn">é–‹å§‹</button>
  </div>
  <div id="output"></div>

  <script>
    function calculateNetMonthly(salaryAnnual) {
      const social = salaryAnnual * 0.14;
      const taxable = Math.max(0, salaryAnnual - social - 480000);
      const brackets = [
        { up:1950000, rate:0.05 },{ up:3300000, rate:0.10 },
        { up:6950000, rate:0.20 },{ up:9000000, rate:0.23 },
        { up:18000000, rate:0.33 },{ up:40000000, rate:0.40 },
        { up:Infinity, rate:0.45 }
      ];
      let tax=0, prev=0;
      for(const b of brackets){ if(taxable<=prev) break; const amt=Math.min(b.up, taxable)-prev; tax+=amt*b.rate; prev=b.up; }
      const resident = taxable * 0.10;
      return (salaryAnnual - social - tax - resident) / 12;
    }

    function simulateRetirement(opts) {
      const {
        startAge, retirementAge, pensionStartAge, gapIncome,
        salary, monthlyPension,
        initialCash, initialInv,
        expenseCurrent, expenseGap, expenseRetired,
        investRate, annualInterest,
        eventProb, eventTypes
      } = opts;

      let cash = initialCash;
      let investBal = initialInv;
      const lines = [];

      for(let age = startAge; age <= 100; age++){
        for(let m = 1; m <= 12; m++){
          // å¹´åˆ æŠ•è³‡æ®‹é«˜ã¸åˆ©æ¯é©ç”¨
          if(m === 1 && age > startAge){
            const before = investBal;
            investBal *= (1 + annualInterest);
            lines.push(`== ${age}æ­³ 1æœˆ: æŠ•è³‡åˆ©æ¯ ==`);
            lines.push(`  æŠ•è³‡: Â¥${before.toLocaleString()} â†’ Â¥${Math.round(investBal).toLocaleString()}`);
          }
          // åå…¥åˆ¤å®š
          let incomeText = '';
          if(age < retirementAge){
            const net = calculateNetMonthly(salary);
            const invAmt = net * investRate;
            investBal += invAmt;
            cash += (net - invAmt);
            incomeText = `çµ¦ä¸: Â¥${Math.round(net).toLocaleString()} (æŠ•è³‡: Â¥${Math.round(invAmt).toLocaleString()})`;
          } else if(age < pensionStartAge){
            cash += gapIncome;
            incomeText = `é€€è·å¾Œåå…¥: Â¥${gapIncome.toLocaleString()}`;
          } else {
            cash += monthlyPension;
            incomeText = `å¹´é‡‘: Â¥${monthlyPension.toLocaleString()}`;
          }
          // ç”Ÿæ´»è²»å·®å¼•
          let cost;
          if(age < retirementAge) cost = expenseCurrent;
          else if(age < pensionStartAge) cost = expenseGap;
          else cost = expenseRetired;
          cash -= cost;
          // ã‚¤ãƒ™ãƒ³ãƒˆ
          const evtLines = [];
          if(Math.random() < eventProb){
            const e = eventTypes[Math.floor(Math.random()*eventTypes.length)];
            cash -= e.cost;
            evtLines.push(`â–¶ ${e.name}: Â¥${e.cost.toLocaleString()}`);
          }
          // æŠ•è³‡è£œå¡«
          if(cash < 0 && investBal > 0){
            const need = -cash;
            const draw = Math.min(investBal, need);
            const tax = draw * 0.2;  // 20%ã®ç¨é‡‘
            investBal -= (draw + tax);  // è£œå¡«é¡ + ç¨é‡‘ã‚’å¼•ã
            cash += draw;  // ç¾é‡‘ã«ã¯è£œå¡«é¡ã®ã¿è¿½åŠ 
            evtLines.push(`ğŸ”„ æŠ•è³‡ã‹ã‚‰è£œå¡«: Â¥${draw.toLocaleString()} (ç¨é‡‘: Â¥${Math.round(tax).toLocaleString()})`);
          }
          // å‡ºåŠ›
          lines.push(`-- ${age}æ­³${m}æœˆ --`);
          lines.push(`  ${incomeText}`);
          lines.push(`  ç”Ÿæ´»è²»: Â¥${cost.toLocaleString()}`);
          evtLines.forEach(l => lines.push(`  ${l}`));
          const total = cash + investBal;
          lines.push(`  ç¾é‡‘: Â¥${Math.round(cash).toLocaleString()} æŠ•è³‡: Â¥${Math.round(investBal).toLocaleString()} ç·è³‡ç”£: Â¥${Math.round(total).toLocaleString()}`);
        }
      }
      return lines;
    }

    function runSimulation(){
      const get = id => parseFloat(document.getElementById(id).value) || 0;
      const opts = {
        startAge: get('startAge'), retirementAge: get('retirementAge'),
        pensionStartAge: get('pensionStartAge'), gapIncome: get('gapIncome'),
        salary: get('salary'), monthlyPension: get('monthlyPension'),
        initialCash: get('initialCash'), initialInv: get('initialInv'),
        expenseCurrent: get('expenseCurrent'), expenseGap: get('expenseGap'), expenseRetired: get('expenseRetired'),
        investRate: get('investRate')/100, annualInterest: get('interest')/100,
        eventProb: get('eventProb')/100,
        eventTypes: [
          {name:'å…¥é™¢',cost:200000},{name:'æ­¯ç§‘æ²»ç™‚',cost:50000},{name:'è–¬ã®è³¼å…¥',cost:20000},
          {name:'å®¶é›»æ•…éšœ',cost:100000},{name:'è»Šæ¤œ',cost:80000},{name:'å† å©šè‘¬ç¥­',cost:120000},
          {name:'å¥åº·è¨ºæ–­',cost:30000},{name:'å¼•è¶Šã—',cost:200000}
        ]
      };
      const res = simulateRetirement(opts);
      document.getElementById('output').textContent = res.join('\n');
    }

    function runTests(){
      console.assert(calculateNetMonthly(0)===0,'net0');
      console.assert(calculateNetMonthly(1200000)>0,'net>0');
      // gapIncome test
      const optsGap={startAge:65, retirementAge:65, pensionStartAge:67, gapIncome:5000,
        salary:0, monthlyPension:0, initialCash:0, initialInv:0,
        expenseCurrent:100, expenseGap:200, expenseRetired:300,
        investRate:0, annualInterest:0, eventProb:0, eventTypes:[]};
      const outGap=simulateRetirement(optsGap);
      console.assert(outGap[0].includes('é€€è·å¾Œåå…¥: Â¥5,000'),'gap income line');
      console.assert(outGap[1].includes('ç”Ÿæ´»è²»: Â¥200'),'gap expense line');
    }

    document.addEventListener('DOMContentLoaded',()=>{
      runTests();
      document.getElementById('runBtn').addEventListener('click',runSimulation);
    });
  </script>
</body>
</html>
