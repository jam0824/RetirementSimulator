<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è€å¾Œè³‡é‡‘ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆ</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .test-section { margin-bottom: 30px; border: 1px solid #ddd; padding: 15px; }
    .test-result { margin: 5px 0; padding: 5px; border-radius: 3px; }
    .pass { background-color: #d4edda; color: #155724; }
    .fail { background-color: #f8d7da; color: #721c24; }
    .test-summary { font-weight: bold; font-size: 18px; margin-bottom: 20px; }
    pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; }
  </style>
</head>
<body>
  <h1>è€å¾Œè³‡é‡‘ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆ</h1>
  <div id="test-output"></div>

  <script>
    // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã®é–¢æ•°ã‚’èª­ã¿è¾¼ã¿ï¼ˆå®Ÿéš›ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã‚³ãƒ”ãƒ¼ï¼‰
    function calculateNetMonthly(salaryAnnual) {
      const social = salaryAnnual * 0.14;
      const taxable = Math.max(0, salaryAnnual - social - 480000);
      const brackets = [
        { up:1950000, rate:0.05 },{ up:3300000, rate:0.10 },
        { up:6950000, rate:0.20 },{ up:9000000, rate:0.23 },
        { up:18000000, rate:0.33 },{ up:40000000, rate:0.40 },
        { up:Infinity, rate:0.45 }
      ];
      let tax=0, prev=0;
      for(const b of brackets){ if(taxable<=prev) break; const amt=Math.min(b.up, taxable)-prev; tax+=amt*b.rate; prev=b.up; }
      const resident = taxable * 0.10;
      return (salaryAnnual - social - tax - resident) / 12;
    }

    function simulateRetirement(opts) {
      const {
        startAge, retirementAge, pensionStartAge, gapIncome,
        salary, monthlyPension,
        initialCash, initialInv,
        expenseCurrent, expenseGap, expenseRetired,
        investRate, annualInterest,
        eventProb, eventTypes
      } = opts;

      let cash = initialCash;
      let investBal = initialInv;
      const listLines = [];

      for(let age = startAge; age <= 100; age++){
        for(let m = 1; m <= 12; m++){
          // å¹´åˆ æŠ•è³‡æ®‹é«˜ã¸åˆ©æ¯é©ç”¨
          if(m === 1 && age > startAge){
            const before = investBal;
            investBal *= (1 + annualInterest);
            listLines.push(`== ${age}æ­³ 1æœˆ: æŠ•è³‡åˆ©æ¯ ==`);
            listLines.push(`  æŠ•è³‡: Â¥${before.toLocaleString()} â†’ Â¥${Math.round(investBal).toLocaleString()}`);
          }
          // åå…¥åˆ¤å®š
          let incomeText = '';
          if(age < retirementAge){
            const net = calculateNetMonthly(salary);
            const invAmt = net * investRate;
            investBal += invAmt;
            cash += (net - invAmt);
            incomeText = `çµ¦ä¸: Â¥${Math.round(net).toLocaleString()} (æŠ•è³‡: Â¥${Math.round(invAmt).toLocaleString()})`;
          } else if(age < pensionStartAge){
            cash += gapIncome;
            incomeText = `é€€è·å¾Œåå…¥: Â¥${gapIncome.toLocaleString()}`;
          } else {
            cash += monthlyPension;
            incomeText = `å¹´é‡‘: Â¥${monthlyPension.toLocaleString()}`;
          }
          // ç”Ÿæ´»è²»å·®å¼•
          let cost;
          if(age < retirementAge) cost = expenseCurrent;
          else if(age < pensionStartAge) cost = expenseGap;
          else cost = expenseRetired;
          cash -= cost;
          // ã‚¤ãƒ™ãƒ³ãƒˆ
          const listEvents = [];
          if(Math.random() < eventProb){
            const e = eventTypes[Math.floor(Math.random()*eventTypes.length)];
            cash -= e.cost;
            listEvents.push(`â–¶ ${e.name}: Â¥${e.cost.toLocaleString()}`);
          }
          // æŠ•è³‡è£œå¡«
          if(cash < 0 && investBal > 0){
            const need = -cash;
            const draw = Math.min(investBal, need);
            investBal -= draw;
            cash += draw;
            listEvents.push(`ğŸ”„ æŠ•è³‡ã‹ã‚‰è£œå¡«: Â¥${draw.toLocaleString()}`);
          }
          // å‡ºåŠ›
          listLines.push(`-- ${age}æ­³${m}æœˆ --`);
          listLines.push(`  ${incomeText}`);
          listLines.push(`  ç”Ÿæ´»è²»: Â¥${cost.toLocaleString()}`);
          listEvents.forEach(l => listLines.push(`  ${l}`));
          const total = cash + investBal;
          listLines.push(`  ç¾é‡‘: Â¥${Math.round(cash).toLocaleString()} æŠ•è³‡: Â¥${Math.round(investBal).toLocaleString()} ç·è³‡ç”£: Â¥${Math.round(total).toLocaleString()}`);
        }
      }
      return listLines;
    }

    // ãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯
    class TestSuite {
      constructor() {
        this.listTests = [];
        this.listResults = [];
      }

      test(name, testFn) {
        this.listTests.push({ name, testFn });
      }

      run() {
        this.listResults = [];
        for(const test of this.listTests) {
          try {
            test.testFn();
            this.listResults.push({ name: test.name, passed: true, error: null });
          } catch (error) {
            this.listResults.push({ name: test.name, passed: false, error: error.message });
          }
        }
        this.displayResults();
      }

      displayResults() {
        const output = document.getElementById('test-output');
        const passed = this.listResults.filter(r => r.passed).length;
        const total = this.listResults.length;
        
        output.innerHTML = `
          <div class="test-summary ${passed === total ? 'pass' : 'fail'}">
            ãƒ†ã‚¹ãƒˆçµæœ: ${passed}/${total} é€šé
          </div>
        `;

        for(const result of this.listResults) {
          const div = document.createElement('div');
          div.className = `test-result ${result.passed ? 'pass' : 'fail'}`;
          div.innerHTML = `
            <strong>${result.passed ? 'âœ“' : 'âœ—'} ${result.name}</strong>
            ${result.error ? `<br><small>ã‚¨ãƒ©ãƒ¼: ${result.error}</small>` : ''}
          `;
          output.appendChild(div);
        }
      }
    }

    function assertEquals(actual, expected, message = '') {
      if (actual !== expected) {
        throw new Error(`æœŸå¾…å€¤: ${expected}, å®Ÿéš›: ${actual} ${message}`);
      }
    }

    function assertApproxEquals(actual, expected, tolerance = 0.01, message = '') {
      if (Math.abs(actual - expected) > tolerance) {
        throw new Error(`æœŸå¾…å€¤: ${expected} (Â±${tolerance}), å®Ÿéš›: ${actual} ${message}`);
      }
    }

    function assertTrue(condition, message = '') {
      if (!condition) {
        throw new Error(`æ¡ä»¶ãŒ false ã§ã™ ${message}`);
      }
    }

    function assertContains(text, substring, message = '') {
      if (!text.includes(substring)) {
        throw new Error(`"${substring}" ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ in "${text}" ${message}`);
      }
    }

    // ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    const suite = new TestSuite();

    // calculateNetMonthly ã®ãƒ†ã‚¹ãƒˆ
    suite.test('å¹´å0å††ã®å ´åˆã¯æ‰‹å–ã‚Š0å††', () => {
      assertEquals(calculateNetMonthly(0), 0);
    });

    suite.test('å¹´å300ä¸‡å††ã®æ‰‹å–ã‚Šè¨ˆç®—', () => {
      const result = calculateNetMonthly(3000000);
      assertTrue(result > 0, 'æ‰‹å–ã‚Šã¯æ­£ã®å€¤ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™');
      assertTrue(result < 3000000 / 12, 'æ‰‹å–ã‚Šã¯å¹´åÃ·12ã‚ˆã‚Šå°‘ãªã„å¿…è¦ãŒã‚ã‚Šã¾ã™');
      assertApproxEquals(result, 188125, 1000, 'å¹´å300ä¸‡å††ã®æœˆæ‰‹å–ã‚Šã¯ç´„18.8ä¸‡å††');
    });

    suite.test('å¹´å600ä¸‡å††ã®æ‰‹å–ã‚Šè¨ˆç®—', () => {
      const result = calculateNetMonthly(6000000);
      assertTrue(result > calculateNetMonthly(3000000), 'å¹´åãŒé«˜ã„ã»ã©æ‰‹å–ã‚Šã‚‚å¤šã„');
      assertApproxEquals(result, 348625, 1000, 'å¹´å600ä¸‡å††ã®æœˆæ‰‹å–ã‚Šã¯ç´„34.9ä¸‡å††');
    });

    suite.test('å¹´å1000ä¸‡å††ã®æ‰‹å–ã‚Šè¨ˆç®—ï¼ˆé«˜æ‰€å¾—ç¨ç‡é©ç”¨ï¼‰', () => {
      const result = calculateNetMonthly(10000000);
      assertTrue(result > calculateNetMonthly(6000000), 'å¹´åãŒé«˜ã„ã»ã©æ‰‹å–ã‚Šã‚‚å¤šã„');
      assertApproxEquals(result, 546367, 1000, 'å¹´å1000ä¸‡å††ã®æœˆæ‰‹å–ã‚Šã¯ç´„54.6ä¸‡å††');
    });

    // simulateRetirement ã®ãƒ†ã‚¹ãƒˆ
    suite.test('åŸºæœ¬çš„ãªã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œãƒ†ã‚¹ãƒˆ', () => {
      const listOptions = {
        startAge: 30, retirementAge: 65, pensionStartAge: 65, gapIncome: 0,
        salary: 3000000, monthlyPension: 150000,
        initialCash: 1000000, initialInv: 0,
        expenseCurrent: 150000, expenseGap: 200000, expenseRetired: 200000,
        investRate: 0.2, annualInterest: 0.04,
        eventProb: 0, eventTypes: []
      };
      const listResults = simulateRetirement(listOptions);
      assertTrue(listResults.length > 0, 'ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹');
      assertContains(listResults[0], '30æ­³1æœˆ', 'é–‹å§‹å¹´é½¢ãŒæ­£ã—ãåæ˜ ã•ã‚Œã¦ã„ã‚‹');
    });

    suite.test('é€€è·å¾Œåå…¥æœŸé–“ã®ãƒ†ã‚¹ãƒˆ', () => {
      const listOptions = {
        startAge: 65, retirementAge: 65, pensionStartAge: 67, gapIncome: 50000,
        salary: 0, monthlyPension: 150000,
        initialCash: 1000000, initialInv: 0,
        expenseCurrent: 100000, expenseGap: 200000, expenseRetired: 200000,
        investRate: 0, annualInterest: 0,
        eventProb: 0, eventTypes: []
      };
      const listResults = simulateRetirement(listOptions);
      const listGapPeriod = listResults.filter(line => line.includes('é€€è·å¾Œåå…¥'));
      assertTrue(listGapPeriod.length > 0, 'é€€è·å¾Œåå…¥æœŸé–“ãŒå­˜åœ¨ã™ã‚‹');
      assertContains(listGapPeriod[0], 'Â¥50,000', 'é€€è·å¾Œåå…¥é‡‘é¡ãŒæ­£ã—ã„');
    });

    suite.test('å¹´é‡‘å—çµ¦æœŸé–“ã®ãƒ†ã‚¹ãƒˆ', () => {
      const listOptions = {
        startAge: 67, retirementAge: 65, pensionStartAge: 67, gapIncome: 0,
        salary: 0, monthlyPension: 150000,
        initialCash: 1000000, initialInv: 0,
        expenseCurrent: 100000, expenseGap: 200000, expenseRetired: 200000,
        investRate: 0, annualInterest: 0,
        eventProb: 0, eventTypes: []
      };
      const listResults = simulateRetirement(listOptions);
      const listPensionPeriod = listResults.filter(line => line.includes('å¹´é‡‘'));
      assertTrue(listPensionPeriod.length > 0, 'å¹´é‡‘å—çµ¦æœŸé–“ãŒå­˜åœ¨ã™ã‚‹');
      assertContains(listPensionPeriod[0], 'Â¥150,000', 'å¹´é‡‘é‡‘é¡ãŒæ­£ã—ã„');
    });

    suite.test('æŠ•è³‡åˆ©å›ã‚Šã®é©ç”¨ãƒ†ã‚¹ãƒˆ', () => {
      const listOptions = {
        startAge: 30, retirementAge: 31, pensionStartAge: 31, gapIncome: 0,
        salary: 0, monthlyPension: 0,
        initialCash: 0, initialInv: 1000000,
        expenseCurrent: 0, expenseGap: 0, expenseRetired: 0,
        investRate: 0, annualInterest: 0.1,
        eventProb: 0, eventTypes: []
      };
      const listResults = simulateRetirement(listOptions);
      const listInterestLines = listResults.filter(line => line.includes('æŠ•è³‡åˆ©æ¯') || line.includes('â†’'));
      assertTrue(listInterestLines.length > 0, 'æŠ•è³‡åˆ©æ¯ãŒé©ç”¨ã•ã‚Œã¦ã„ã‚‹');
      const listDetailLine = listResults.find(line => line.includes('Â¥1,000,000') && line.includes('â†’'));
      assertTrue(listDetailLine !== undefined, 'æŠ•è³‡åˆ©æ¯ã®è©³ç´°è¡ŒãŒå­˜åœ¨ã™ã‚‹');
      assertContains(listDetailLine, 'Â¥1,100,000', '10%ã®åˆ©å›ã‚ŠãŒæ­£ã—ãé©ç”¨ã•ã‚Œã¦ã„ã‚‹');
    });

    suite.test('æŠ•è³‡è£œå¡«æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ', () => {
      const listOptions = {
        startAge: 30, retirementAge: 30, pensionStartAge: 30, gapIncome: 0,
        salary: 0, monthlyPension: 0,
        initialCash: 50000, initialInv: 100000,
        expenseCurrent: 0, expenseGap: 0, expenseRetired: 80000,
        investRate: 0, annualInterest: 0,
        eventProb: 0, eventTypes: []
      };
      const listResults = simulateRetirement(listOptions);
      const listSupplementLines = listResults.filter(line => line.includes('æŠ•è³‡ã‹ã‚‰è£œå¡«'));
      assertTrue(listSupplementLines.length > 0, 'æŠ•è³‡ã‹ã‚‰è£œå¡«ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹');
    });

    suite.test('ç¾å½¹æ™‚æŠ•è³‡ç‡ã®ãƒ†ã‚¹ãƒˆ', () => {
      const listOptions = {
        startAge: 30, retirementAge: 31, pensionStartAge: 31, gapIncome: 0,
        salary: 2400000, monthlyPension: 0,
        initialCash: 0, initialInv: 0,
        expenseCurrent: 100000, expenseGap: 0, expenseRetired: 0,
        investRate: 0.5, annualInterest: 0,
        eventProb: 0, eventTypes: []
      };
      const listResults = simulateRetirement(listOptions);
      const listInvestmentLines = listResults.filter(line => line.includes('æŠ•è³‡:'));
      assertTrue(listInvestmentLines.length > 0, 'æŠ•è³‡ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹');
    });

    suite.test('ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹: è² ã®å¹´é½¢', () => {
      const listOptions = {
        startAge: -1, retirementAge: 65, pensionStartAge: 65, gapIncome: 0,
        salary: 3000000, monthlyPension: 150000,
        initialCash: 1000000, initialInv: 0,
        expenseCurrent: 150000, expenseGap: 200000, expenseRetired: 200000,
        investRate: 0.2, annualInterest: 0.04,
        eventProb: 0, eventTypes: []
      };
      // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã›ãšã€é©åˆ‡ã«å‡¦ç†ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      const listResults = simulateRetirement(listOptions);
      assertTrue(listResults.length >= 0, 'è² ã®å¹´é½¢ã§ã‚‚ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãªã„');
    });

    suite.test('ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹: ç„¡åŠ¹ãªæŠ•è³‡ç‡', () => {
      const result1 = calculateNetMonthly(3000000);
      assertTrue(result1 > 0, 'æ­£å¸¸ãªå¹´åã§æ‰‹å–ã‚ŠãŒè¨ˆç®—ã•ã‚Œã‚‹');
      
      // æŠ•è³‡ç‡ãŒ100%ã‚’è¶…ãˆã‚‹å ´åˆ
      const listOptions = {
        startAge: 30, retirementAge: 31, pensionStartAge: 31, gapIncome: 0,
        salary: 3000000, monthlyPension: 0,
        initialCash: 0, initialInv: 0,
        expenseCurrent: 100000, expenseGap: 0, expenseRetired: 0,
        investRate: 1.5, annualInterest: 0,
        eventProb: 0, eventTypes: []
      };
      const listResults = simulateRetirement(listOptions);
      assertTrue(listResults.length > 0, 'æŠ•è³‡ç‡150%ã§ã‚‚å‡¦ç†ã•ã‚Œã‚‹');
    });

    // çµ±åˆãƒ†ã‚¹ãƒˆ
    suite.test('30å¹´é–“ã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«çµ±åˆãƒ†ã‚¹ãƒˆ', () => {
      const listEventTypes = [
        {name:'åŒ»ç™‚è²»',cost:100000},{name:'å®¶é›»æ•…éšœ',cost:50000}
      ];
      const listOptions = {
        startAge: 30, retirementAge: 60, pensionStartAge: 65, gapIncome: 50000,
        salary: 4000000, monthlyPension: 180000,
        initialCash: 500000, initialInv: 200000,
        expenseCurrent: 180000, expenseGap: 220000, expenseRetired: 250000,
        investRate: 0.25, annualInterest: 0.05,
        eventProb: 0, eventTypes: listEventTypes
      };
      const listResults = simulateRetirement(listOptions);
      
      // å„æœŸé–“ãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
      const listWorkingPeriod = listResults.filter(line => line.includes('çµ¦ä¸:'));
      const listGapPeriod = listResults.filter(line => line.includes('é€€è·å¾Œåå…¥:'));
      const listPensionPeriod = listResults.filter(line => line.includes('å¹´é‡‘:'));
      
      assertTrue(listWorkingPeriod.length > 0, 'ç¾å½¹æœŸé–“ãŒå­˜åœ¨ã™ã‚‹');
      assertTrue(listGapPeriod.length > 0, 'é€€è·å¾Œåå…¥æœŸé–“ãŒå­˜åœ¨ã™ã‚‹');
      assertTrue(listPensionPeriod.length > 0, 'å¹´é‡‘å—çµ¦æœŸé–“ãŒå­˜åœ¨ã™ã‚‹');
      
      // æŠ•è³‡åˆ©æ¯ãŒé©ç”¨ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
      const listInterestLines = listResults.filter(line => line.includes('æŠ•è³‡åˆ©æ¯'));
      assertTrue(listInterestLines.length > 0, 'æŠ•è³‡åˆ©æ¯ãŒé©ç”¨ã•ã‚Œã¦ã„ã‚‹');
    });

    // DOMèª­ã¿è¾¼ã¿å®Œäº†å¾Œã«ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    document.addEventListener('DOMContentLoaded', () => {
      suite.run();
    });
  </script>
</body>
</html> 